# 開発進捗引き継ぎ書

ここに各フェーズで行われた変更を記録し、別のタスクが誤った前提で動かないようにする。

---

## **Phase 0: 基盤整備**
**目標**: 開発環境とデータ構造の確立

### **Claude で行うこと:**
- ✅ データ構造の詳細設計（JSON Schema）
- ✅ ファイル構成の決定
- ✅ 状態管理パターンの選定

### **Claude で行ったこと:**

#### 1. データ構造の詳細設計（完了）

**localStorageキー構造:**
```javascript
{
  "jetpallet_character": {...},      // キャラクター設定
  "jetpallet_abilities": [...],      // アビリティ一覧
  "jetpallet_buffs_library": [...],  // バフライブラリ
  "jetpallet_active_buffs": [...],   // アクティブなバフ
  "jetpallet_resources": [...],      // リソース一覧
  "jetpallet_settings": {...}        // アプリ設定
}
```

**主要なデータ型:**
- **Character**: 操作モード、名前、ジョブ、レベル、使用ステータス
- **Ability**: 種別、アイコン、タグ、判定、ダメージ、効果、マクロ、UI配置情報
- **Buff Library**: バフ・デバフのテンプレート
- **Active Buff**: 現在有効なバフ（スタック数、残りターン数）
- **Resource**: MP等のリソース（現在値、最大値、表示スタイル、色）
- **Macro**: 条件ブロックとアクションブロックの配列

**ID管理方式:**
- UUID v4 を使用（処理負担はほぼ変わらないため）
- すべてのエンティティに一意のIDを付与

**画像ファイル管理:**
- `assets/icons/` 配下のファイル名のみを文字列で保存
- 例: `"iconFileName": "sprint.png"`

**初期データ:**
- デフォルトで「スプリント」アビリティを配置
  - 種別: メイン
  - 効果: このターン中、君の【移動速度】が2倍になる

#### 2. ファイル構成の決定（完了）

```
project/
├── index.html (基本構造) ✅ 既存
├── styles/
│   ├── theme-dracula.css ✅ 既存
│   ├── main.css ✅ 既存
│   └── components.css (新規) ⏳ 次のステップ
├── scripts/
│   ├── data/
│   │   ├── schema.js (データ型定義) ⏳ 次のステップ
│   │   └── default-data.js (初期データ) ⏳ 次のステップ
│   ├── core/
│   │   ├── state-manager.js (状態管理) ⏳ 次のステップ
│   │   └── macro-executor.js (マクロ実行エンジン) 📅 Phase 5
│   ├── ui/
│   │   ├── ability-list.js (アビリティ表示) 📅 Phase 1
│   │   ├── buff-area.js (バフ表示) 📅 Phase 1
│   │   ├── resource-display.js (リソース表示) 📅 Phase 2
│   │   └── command-generator.js (コマンド生成) 📅 Phase 1
│   └── main.js (エントリーポイント) ⏳ 次のステップ
└── assets/
    └── icons/ (アイコン置き場) ✅ 既存
```

**凡例:**
- ✅ 既存・完了
- ⏳ 次のステップで作成予定
- 📅 後のPhaseで作成予定

#### 3. 状態管理パターンの選定（完了）

**採用パターン: Observable Store パターン**

**選定理由:**
- ✅ シンプルで理解しやすい
- ✅ localStorageとの連携が容易
- ✅ イベント駆動で必要な部分だけ更新
- ✅ 外部ライブラリ不要（Vanilla JS）
- ✅ デバッグしやすい

**主要な機能:**
1. **データ取得**: `getAbilities()`, `getCharacter()` など
2. **データ更新**: `updateAbility()`, `addAbility()` など（自動保存付き）
3. **購読（Observer）**: `subscribe('abilities', callback)` でデータ変更を監視
4. **ゲームアクション**: `endTurn()`, `startTurn()`, `endRound()`, `updatePhase()`
5. **インポート/エクスポート**: JSON形式でのデータ入出力

**状態管理の流れ:**
```
UI操作
  ↓
stateManager.updateXxx()
  ↓
内部stateを更新 + localStorage保存
  ↓
購読中のコールバックに通知
  ↓
UI自動更新
```

**マクロ実行時の流れ:**
```
アビリティクリック
  ↓
MacroExecutor.execute()
  ↓
前提条件チェック
  ↓
アクション順次実行（リソース増減、バフ追加など）
  ↓
各アクションが stateManager 経由で状態更新
  ↓
UI自動更新
```

---

### **codex で行うこと:**
- ⏳ プロジェクトファイルの作成
- ⏳ 基本的なHTML構造の実装
- ⏳ CSS変数とユーティリティクラスの整備

### **codex で行ったこと:**
（まだ未着手）

---

### **成果物（予定）:**
```
project/
├── index.html (基本構造)
├── styles/
│   ├── theme-dracula.css
│   ├── main.css
│   └── components.css (新規)
├── scripts/
│   ├── data/
│   │   ├── schema.js (データ型定義)
│   │   └── default-data.js (初期データ)
│   ├── core/
│   │   └── state-manager.js (状態管理)
│   └── main.js
└── assets/
    └── icons/ (アイコン置き場)
```

---

## **次のステップ（Phase 0 完了に向けて）**

### codex で実装するファイル:
1. **`scripts/core/state-manager.js`**
   - Observable Store パターンの実装
   - localStorage連携
   - UUID生成ユーティリティ

2. **`scripts/data/default-data.js`**
   - 初期キャラクターデータ
   - 「スプリント」アビリティ
   - デフォルトMPリソース

3. **`scripts/main.js`**
   - StateManager初期化
   - モジュール読み込み

4. **`styles/components.css`**
   - 共通コンポーネントスタイル
   - ユーティリティクラス

### 実装優先順位:
1. state-manager.js（最優先）
2. default-data.js
3. main.js
4. components.css

---

## **設計上の重要な決定事項**

### データ管理
- **ID**: UUID v4を全エンティティに使用
- **画像**: ファイル名のみ保存、実体は `assets/icons/` に配置
- **保存**: 各データ更新時に自動的にlocalStorageへ保存

### バフの扱い
- **同名バフの重複**: 許容する（スタック数で管理）
- **継続時間**: `PERMANENT` | `TURN_END` | `NEXT_TURN_START`
- **ライブラリとアクティブ**: 分離管理

### リソースの扱い
- **値の制限**: 0 ≤ currentValue ≤ maxValue
- **MP**: `isDefault: true` で特別扱い
- **表示スタイル**: GAUGE | STACK_ARROW | STACK_CIRCLE | STACK_SQUARE

### マクロの扱い
- **実行順序**: 配列の順番通りに実行
- **条件評価**: AND/ORをサポート
- **ネスト**: 条件成立時のアクションをサポート

---

## **Phase 1以降への引き継ぎ事項**

### UI実装時の注意点
1. **購読パターンの使用**: `stateManager.subscribe()` で状態変更を監視
2. **直接DOM操作の禁止**: 必ず stateManager 経由でデータ更新
3. **クリーンアップ**: コンポーネント破棄時に `unsubscribe()` を呼ぶ

### コマンド生成について
- バフの効果はコマンド生成時にリアルタイム反映
- `{STR}` などのプレースホルダーを置換
- ダイレクトヒット、クリティカルの処理も考慮

### マクロシステムについて
- Phase 5で本格実装
- データ構造は既に確定しているため、実行エンジンの実装に専念できる

---

**最終更新**: 2025年1月22日（Phase 1 Step 1-3 実装完了）

---

## **Phase 1: シンプルモード実装**
**目標**: 基本的なアビリティ管理とコマンド生成

### **実装完了:**
✅ **Step 1.1: アビリティ表示**
- `scripts/ui/ability-card.js` - アビリティカードコンポーネント
  - `createAbilityCardElement()`: カード要素生成
  - `createAbilityTooltip()`: ツールチップ表示
  - `getCategoryDisplay()`: カテゴリー名表示
- `scripts/ui/ability-area.js` - アビリティエリア管理
  - セクション分類（MAIN, SUB, INSTANT, SPECIAL）
  - グリッドレイアウト
  - リアルタイム更新

✅ **Step 1.2: コマンド生成**
- `scripts/ui/command-generator.js` - BCdiceコマンド生成
  - `generateCommand()`: 判定・ダメージコマンド生成
  - `buildCheckCommand()`: 判定修正の集計
  - `buildDamageCommand()`: ダメージ計算
  - `applyCritical()`: クリティカル処理
  - `decrementAbilityStack()`: スタック数管理

✅ **Step 1.3: バフ管理**
- `scripts/ui/buff-area.js` - バフ表示管理
  - `createBuffElement()`: バフ要素生成
  - `createBuffTooltip()`: バフツールチップ
  - `getDurationDisplay()`: 継続時間表示
  - `addBuffFromLibrary()`: ライブラリから追加
- `styles/components.css` - バフ・アビリティUI スタイル追加
  - `.buff-area` - バフ表示エリア
  - `.buff` - バフアイテム
  - `.ability-section` - アビリティセクション
  - `.ability-card` - アビリティカード
  - `.abilities-grid` - グリッドレイアウト

✅ **コア機能の拡張**
- `scripts/core/state-manager.js` 拡張
  - `startTurn()`: 1tバフ削除
  - `endTurn()`: 0tバフ削除
  - `endRound()`: MP +2
  - `updatePhase()`: 全バフ削除
  - `addBuff()`: バフ追加
  - `removeBuff()`: バフ削除
  - `updateResource()`: リソース更新
  - localStorage 自動保存機能

✅ **デフォルトデータ更新**
- `scripts/data/default-data.js` 拡張
  - 5つのテストアビリティ
  - 2つのテストバフ
  - MP・闘気リソース設定

✅ **HTMLとエントリーポイント更新**
- `index.html` 更新
  - `#buff-container` 追加
  - `.ability-container` 追加
  - ゲーム制御ボタンにID追加（btn-start-turn, btn-end-turn等）
  - モジュールスクリプト読み込み
- `scripts/main.js` 実装
  - StateManager初期化
  - コンポーネント統合
  - イベント登録
  - ゲーム操作ロジック

### **検証ポイント:**
- ✅ アビリティをクリックしてコマンド生成できる
- ✅ バフがコマンドに反映される
- ✅ ターン終了ボタンでバフが削除される
- ✅ ラウンド終了ボタンでMP増加
- ✅ フェイズ更新ボタンで全バフ削除
- ⏳ バフの視覚的表示（ツールチップ含む）

### **ファイル一覧:**

#### 新規作成:
```
scripts/ui/
├── ability-card.js       ✅ 完成
├── ability-area.js       ✅ 完成
├── buff-area.js          ✅ 完成
└── command-generator.js  ✅ 完成

scripts/main.js           ✅ 完成
```

#### 更新:
```
scripts/core/state-manager.js      ✅ 拡張完成
scripts/data/default-data.js       ✅ 拡張完成
styles/components.css               ✅ スタイル追加
index.html                          ✅ マークアップ追加
```

### **次フェーズ（Phase 2）への引き継ぎ:**

#### リソース管理の実装予定
- `scripts/ui/resource-display.js` （未実装）
  - リソース表示コンポーネント
  - スタック/ゲージ表示切り替え
  - +/-ボタン機能

#### 今後の拡張点
1. **ダイレクトヒット・クリティカルUI**
   - ボタン表示と状態管理
   
2. **リソース表示**
   - SVG ゲージ実装
   - スタック表示
   
3. **データ永続化**
   - エクスポート/インポート
   - JSON保存機能

4. **マクロシステム（Phase 3以降）**
   - 前提条件評価エンジン
   - アクション実行エンジン
   - ビジュアルマクロエディタ

---

**最終更新**: 2025年1月22日（Phase 1 実装完了）

---

## **Phase 2: リソース管理**
**目標**: MP・カスタムリソースの実装

### **実装完了:**
✅ **リソース表示コンポーネント**
- `scripts/ui/resource-display.js` - リソース管理コンポーネント
  - `ResourceDisplay` クラス: リソース表示・操作管理
  - `#createResourceElement()`: リソース要素生成
  - `#createGaugeDisplay()`: ゲージ表示（MP等）
  - `#createStackDisplay()`: スタック表示（闘気等）
  - `#createControlButtons()`: +/-ボタン生成
  - `#updateResource()`: リソース値更新
  - リアルタイム更新機能

✅ **HTML更新**
- `index.html` - `.trait-area` コンテナ整備
  - ダミーリソース要素をすべて削除
  - JavaScriptで動的生成するように変更

✅ **メイン統合**
- `scripts/main.js` - ResourceDisplay統合
  - `ResourceDisplay` インポート追加
  - initializeApp()内で ResourceDisplay 初期化
  - `.trait-area` セレクタでマウント

✅ **CSS確認**
- `styles/main.css` - リソーススタイル既存
  - `.resource__group`, `.resource__label`
  - `.resource--gauge`, `.resource--stack`
  - `.resource__control`, `.resource__btn`
  - `.resource__icon--gauge`, `.resource__icon--arrow`

### **検証ポイント:**
- ✅ MP がゲージ表示される
- ✅ 闘気がスタック表示される
- ✅ +/-ボタンでリソース値が変動する
- ✅ 値が 0 ≤ value ≤ max の範囲内に制限される
- ✅ リソース情報がlocalStorageに保存される

### **ファイル一覧:**

#### 新規作成:
```
scripts/ui/
└── resource-display.js       ✅ 完成
```

#### 更新:
```
index.html                     ✅ HTML更新
scripts/main.js                ✅ 統合完成
```

### **実装の詳細:**

#### ResourceDisplay の機能
1. **リソース表示**:
   - type が 'gauge' の場合: ゲージ + 値表示
   - type が 'stack' の場合: 複数の画像要素で表現

2. **インタラクション**:
   - +/-ボタンでリソース値を変更
   - 値の自動制限 (0 ≤ value ≤ max)

3. **状態管理との連携**:
   - StateManager に購読登録
   - リソース更新時は setState() を使用
   - localStorage に自動保存

#### デフォルトリソース (`default-data.js`)
```javascript
resources: [
  {
    id: 'resource-001',
    name: 'MP',
    current: 50,
    max: 100,
    type: 'gauge',
    color: '#4a9eff',
  },
  {
    id: 'resource-002',
    name: '闘気',
    current: 3,
    max: 5,
    type: 'stack',
    color: '#ff6b6b',
  },
]
```

### **次フェーズ（Phase 3）への引き継ぎ:**

#### 実装予定項目
1. **データ永続化** (Phase 3)
   - localStorage完全動作確認
   - JSON エクスポート機能
   - データインポート機能

2. **アビリティ登録UI** (Phase 4)
   - ユーザーが自由にアビリティを作成
   - リアルタイムプレビュー
   - 編集・削除機能

3. **高度な機能** (Phase 5以降)
   - マクロシステム実装
   - ダイレクトヒット・クリティカル管理
   - カスタムリソース追加UI

#### 既知の制限事項
- リソース追加/削除UIはまだ未実装
- リソースのドラッグ&ドロップ並び替えは未実装
- カスタムリソース作成UIは未実装

---

**最終更新**: 2026年1月22日（Phase 2 実装完了）