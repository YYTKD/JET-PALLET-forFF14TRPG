# プロジェクト案：JET-PALLETforEORZER

## 1. プロジェクト概要
- **目的**: FF14 TTRPGのオンラインセッションにおける、リソース管理とアクション処理の自動化。BCdiceでダイスロールするためのコマンドを生成し、ダイスロール自体は外部で行う。
- **ベースUI**: JET-PALLET形式（バフのリアルタイム反映、コマンドの生成）
- **ターゲット**: GMおよびプレイヤー

### レファレンス
- **基幹システム**：JET-PALLET[https://github.com/YYTKD/JET-PALLET]
- **データレファレンス**：GMルールブック[https://gdl.square-enix.com/ffxivttrpg/JP_GM20240523.pdf]、PLルールブック[https://gdl.square-enix.com/ffxivttrpg/JP_PL20240523.pdf]、サンプルキャラクターシート[https://gdl.square-enix.com/ffxivttrpg/character_sheet_Lv30JP_web0801.pdf]、サンプルキャラクターシート⓶[https://gdl.square-enix.com/ffxivttrpg/DLC_character_sheet_BardJP.pdf]

## 2. 技術スタック
- **Frontend**: HTML/CSS/JavaScript

## 3. コア・データ構造 (Schema)
AIがオブジェクトのプロパティを推測しやすくするために定義します。

### キャラクター
グローバル設定の要素を持つ。主にセーブデータの親要素としての意味を持つ。
- `操作モード`：
  ・シンプル…手動でバフの状態を管理し、ボタンのクリックで判定やダメージを生成する。JET-PALLETと同様の操作方法。
  ・カスタム…アビリティにマクロを設定し、使用した際の挙動を自動化する。MPやリソースの状態確認はこのモードでのみ行う。
- `名前及びジョブ`：ユーザーの認識を補助する。数値的な役割はない。
- `使用するステータス`：判定に使用するステータス。{STR},{DEX},{INT},{MND}から選択する。ユーザーの入力補助として使用。

### アビリティ
JET-PALLETでの判定や攻撃にあたる。
**ユーザーがスキルの内容を記録する役割しか持たないものは「ラベル」として説明を割愛します。**
- `種別`: "メイン", "サブ", "インスタント","特殊"から選択する。種別によって配置できる領域が変わる。選択した種別はタグにも含まれる。
- `アイコン`：ラベル。
- `アビリティ名`: ユーザーが自由に入力する。アビリティの名称。
- `スタック数`：使用可能な回数。使うと１減る。0や未入力の場合は回数制限なし。ゲーム上はしばしば制限という形で表現されるが、数値として扱うために別のラベルとする。
- `タグ`：ユーザーが自由に入力する。"物理","魔法","連射","メイン","サブ","風属性",etc.
- `前提`：ラベル
- `タイミング`：ラベル
- `コスト`: ラベル
- `制限`：ラベル
- `対象`：ラベル
- `範囲`：ラベル
- `判定`："d20+{使用するステータス} アビリティ名"という形でBCdiceに使用できるコマンドにする。ステータスを使用しない場合もある。
- `基本ダメージ`：アビリティが基本的に出力するダメージロール。
- `ダイレクトヒット`：「ダイレクトヒット」がONのときに追加するダメージロール。
- `基本効果`：ラベル

#### マクロ
アビリティの使用条件の設定や、使用されたときに実行する行動などを設定する。ビジュアルプログラミングのような操作感で設定できるようにする。カスタムモードでのみ使用。
- `前提条件`：アビリティを使用するために必要な条件。満たしていない場合警告を表示する。
- `アクション`：アビリティを使用したときに実行する行動。MPの消費などもここで設定する。
**マクロブロック**
- `条件`：数値で扱っているデータ（バフの数、リソース、アビリティのスタック数）を対象に比較する。同じグループ内で結んだ条件は連言として扱う。
- `アクション`：実行する行動。条件の直後にある場合は条件を満たした場合のアクションとしてネストされる。
  **増やす**
    数値で扱っているデータ（バフの数、リソース、アビリティのスタック数）を指定の数増加する。上限は越えない。
  **減らす**
    数値で扱っているデータ（バフの数、リソース、アビリティのスタック数）を指定の数減少させる。0未満にはならない。
  **判定・ダメージを追加**
    生成するコマンドに指定の数を追加する。基本ロールはマクロに含まず、デフォルトで設定されているため、このコマンドで設定する必要はない。
  **判定・ダメージを変更**
    基本ロールの内容を書き換える。
  **効果テキストを追加**
    アビリティ名のあとに指定したテキストを追加する。主に数値で扱えない特殊な効果を表すときに使う。
  **選択肢を表示**
    択一の選択肢をダイアログで表示し、選択に応じてアクションを実行する。
    - `質問`：ダイアログに表示するテキスト。 
    - `選択肢`：ダイアログに表示する選択肢。任意の数設定できる。
    - `アクション`：選択肢にネストされたアクション。

### バフ
- `種別`："バフ","デバフ"から選択する。
- `アイコン`：種別に応じたシェイプでクリッピングする。
- `バフ・デバフ名`：ユーザーが自由に入力する。バフの名称。
- `効果説明`：ラベル
- `対象` ：コマンドに影響するバフ・デバフの場合、"判定"か"ダメージ"かを指定する。
- `コマンド`：コマンドに影響するバフ・デバフの場合、"+1"など、BCdice用のコマンド生成時に付与する。
- `追加テキスト`：アビリティ名のあとに指定したテキストを追加する。主に数値で扱えない特殊な効果を表すときに使う。
- `継続時間`：削除されるタイミング。ターン終了ボタンなどの対象に用いる。

### リソース
特別な効果を持たないバフのようなもので、どれだけ存在するかをユーザーやマクロが参照するために用いる。バフが「存在する・しない」を並べるのに対して、リソースは同名のものを許容せず、2以上スタックする。MPはデフォルトで設定されているリソースとして扱う。値が0になってもなくならないので、頻繁にオンオフする場合はバフではなくリソースを使うと良い。
- `リソース名`：ユーザーが自由に入力する。リソースの名称。
- `現在値`：リソースの現在値。0未満にはならない。
- `最大値`：リソースの最大値。
- `スタイル`：リソースの視覚的な形状。
  - **スタック**：上限値と同じ個数が横に並び、現在値と同じ個数が点灯する。
  - **ゲージ**：上限値を100%としてバーを表示する。右下には現在値が表示される。
- `カラー`：表示するスタイルに応じた色の設定。スタックは塗りつぶしが指定色の明るい色で枠線が同系の暗い色、非点灯時の塗りつぶしはより暗い色。ゲージは現在値のバーが指定色になる。

## 4. 操作フィールのイメージ
- アビリティは対応した種別のセクションのアビリティエリアにのみ配置できる。
- アビリティエリアはグリッド上に並び、好きな配置でアビリティをおける。将棋盤とコマのようなイメージ。左詰めなどはしない。
- セクションヘッダーの「⚙セクション設定」から、アビリティエリアの行を増やしたり減らしたりできる。
- 「⚙セクション設定」からは、「アビリティグループ」も追加でき、通常のアビリティエリアの次に表示される。
-　「アビリティグループ」はユーザーが視覚的に整理するための領域。任意のグループ名がつけられる。
-　「アビリティグループ」は各セクションごとに一つまで追加でき、更に追加を選択した場合は既存のアビリティグループの行が増える。

## 5. 実装したい機能（マクロロジック）のイメージ

### 両モード共通の機能
- バフ・デバフを個人ライブラリに登録
- リソースを個人ライブラリに登録
- アビリティを個人ライブラリに登録
- アビリティをクリックすることでスタック数を減らし、コマンドを生成する。
- バフがコマンドにリアルタイムで反映される。
- ターン終了、フェイス進行ボタンによってバフが削除される。

### カスタムモードのみの機能
- 使用条件を満たしていないアビリティは暗く表示される
- 使用条件を満たしているアビリティはオレンジ色の点線が表示される。
- 設定したマクロに応じてバフ、リソース、スタック数の増減などが自動で行われる。


### アビリティ使用フローの例
もっとも複雑になるであろうアビリティを例に分解してみる

**アビリティ「崩拳」**
- 種別：メイン
- タグ：物理、メイン
- 前提: バフ「WSコンボ」を得ている、バフ「参の型」を得ている。
- 判定：d20+{STR}
- スタック数：なし
- 基本効果：対象に4点のダメージを受ける。参の功力を消費可能（+2d6点の追加ダメージと2マスまでの効果移動）。君は壱の型を得る。
- 基本ダメージ：4
- ダイレクトヒット：+2d6

※「○○の型」を前提とするアビリティは、「零の型」を得ている状態でも使用できる。

**「崩拳」処理フロー（イメージ）**
```
使用条件: 
もし以下の条件を満たすなら
    ([参の型]>=[1]
    または
    [零の型]>=[1])
    かつ
    ([WSコンボ]>=[1])

#参の型か零の型のいずれかが１以上あり、かつWSコンボが１以上あるとき、使用可能#

アクション：
1.アクションを実行
    ([参の型]-[1])
    ([零の型]-[1])
    ([WSコンボ]-[1])
    ([壱の型]+[1])

#参の型と零の型とWSコンボを1ずつ減らす。バフもリソースも0未満の値を取らないため、得ていなかったバフに対しても減らす処理をかけても問題ない#
#壱の型を１増やす#

2. もし以下の条件を満たすなら
    ([参の功力]>=[1])
    
    アクションを実行
    1.選択肢を表示
    [参の功力を消費しますか？]
    -[消費する(+2d6)]
        アクションを実行
        ([参の功力]-[1])
        ([ダメージ]+[+2d6])
    -[消費しない]

#1.のアクションをすべて実行後、参の功力が１以上あるなら、選択肢を表示する#
#選択肢１を選択した場合、参の功力を１減らし、ダメージロールに+2d6を追加する#
#選択肢２を選択した場合は、その後にアクションが設定されていないので処理を終了する#
```



## 備考
- バフのコストの中には、指定したリソースを指定した数だけ消費するものと、すべて消費するものがある。
- ルール上「前提」として扱われているものは、実質コストを所持しているか否かで処理できるため、ツール上ではコストの所持状況を前提として判定するのがスマートな気がする。
- コンボ：《〇〇》などは、「〇〇実行可」というバフを付与する、という処理に解釈しなおすことで、コストが必要なアビリティ等と同様に処理できるようにする。
- 同名バフの重複を許容する。本来であればルール上同名のバフは重複しないが、上記の処理をするうえで便宜的に許容する。
- -たとえば、Lv50の吟遊詩人のアビリティ「乱れ打ち」を使用した時、バフ「《ストレートショット》実行可」を１つと、バフ「乱れ打ち」を３つ付与する。これにより、「乱れ打ち」の効果に従って直後に使用した連射アビリティと、その後使用する連射アビリティ２つでバフ「乱れ打ち」を消費しきって、処理が完了したことがユーザーにもわかりやすくなる。
- ターン終了ボタンとフェイズ進行ボタンは、単純に対応したバフの削除や、MPの回復などの機能をつけたボタンにする予定だが、このボタンもマクロを設定できるようにして、特定のバフ（主にアストラルファイア）があるとMPを回復しないなどができるようにしたほうがいいかも。実装方法は要検討。